<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿæœºè¿æ¥ - SPICE</title>
    <link rel="stylesheet" type="text/css" href="/spice-html5/spice.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
        }

        #loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loading-text {
            font-size: 18px;
            font-weight: 500;
        }

        #loading-subtext {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        #error-container {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        #error-message {
            font-size: 18px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .error-back-button {
            padding: 12px 24px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .error-back-button:hover {
            background-color: #5568d3;
        }

        #spice-container {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #spice-area {
            width: 100%;
            height: calc(100vh - 40px);
            position: relative;
        }

        #spice-screen {
            width: 100%;
            height: 100%;
        }

        /* Adjust when in fullscreen */
        #spice-container:-webkit-full-screen #spice-area,
        #spice-container:-moz-full-screen #spice-area,
        #spice-container:fullscreen #spice-area {
            height: 100vh;
            padding-top: 40px;
        }

        /* Control Panel Styles */
        #control-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            padding: 8px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .control-button {
            padding: 6px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .control-button:hover {
            background: #5568d3;
        }

        .control-button.success {
            background: #28a745;
        }

        .control-button.success:hover {
            background: #218838;
        }

        .control-button.danger {
            background: #dc3545;
        }

        .control-button.danger:hover {
            background: #c82333;
        }

        .control-spacer {
            flex: 1;
        }

        #connection-status {
            color: #28a745;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #connection-status::before {
            content: 'â—';
            font-size: 16px;
        }

        /* Fullscreen styles */
        #spice-container:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }

        #spice-container:-moz-full-screen {
            width: 100%;
            height: 100%;
        }

        #spice-container:fullscreen {
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- ES2015/ES6 modules polyfill -->
    <script type="module">
        window._spice_has_module_support = true;
    </script>
    <script>
        window.addEventListener("load", function() {
            if (window._spice_has_module_support) return;
            var loader = document.createElement("script");
            loader.src = "/spice-html5/thirdparty/browser-es-module-loader/dist/browser-es-module-loader.js";
            document.head.appendChild(loader);
        });
    </script>
</head>
<body>
    <!-- Loading State -->
    <div id="loading-container">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨è¿æ¥è™šæ‹Ÿæœº...</div>
        <div id="loading-subtext">è¯·ç¨å€™</div>
    </div>

    <!-- Error State -->
    <div id="error-container">
        <div class="error-icon">âš ï¸</div>
        <div id="error-message"></div>
        <button class="error-back-button" onclick="goBack()">è¿”å›ä»ªè¡¨æ¿</button>
    </div>

    <!-- SPICE Container -->
    <div id="spice-container">
        <div id="control-panel">
            <span id="connection-status">å·²è¿æ¥</span>
            <button class="control-button" id="ctrlAltDelButton">Ctrl+Alt+Del</button>
            <button class="control-button success" id="fullscreenButton">å…¨å±</button>
            <div class="control-spacer"></div>
            <button class="control-button danger" id="disconnectButton">æ–­å¼€è¿æ¥</button>
        </div>
        <div id="spice-area">
            <div id="spice-screen" class="spice-screen"></div>
        </div>
    </div>

    <script type="module">
        import * as SpiceHtml5 from './spice-html5/src/main.js';

        'use strict';

        // Configuration
        const CONFIG = {
            API_ENDPOINT: '/api/spice/connect',
            REDIRECT_DELAY: 2000,
            DEFAULT_SETTINGS: {
                // SPICE settings can be configured here
            }
        };

        // DOM Elements
        const elements = {
            loadingContainer: document.getElementById('loading-container'),
            loadingText: document.getElementById('loading-text'),
            loadingSubtext: document.getElementById('loading-subtext'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            spiceContainer: document.getElementById('spice-container'),
            ctrlAltDelButton: document.getElementById('ctrlAltDelButton'),
            fullscreenButton: document.getElementById('fullscreenButton'),
            disconnectButton: document.getElementById('disconnectButton'),
            connectionStatus: document.getElementById('connection-status')
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const vmId = urlParams.get('id');
        const token = urlParams.get('token') || localStorage.getItem('token');

        let sc = null; // SPICE connection

        // Initialize
        console.log('ğŸš€ [SPICE Client] Initializing...');
        console.log(`   VM ID: ${vmId || 'Not provided'}`);
        console.log(`   Token source: ${urlParams.get('token') ? 'URL parameter' : 'localStorage'}`);

        // Validate inputs
        if (!vmId) {
            showError('ç¼ºå°‘è™šæ‹Ÿæœº ID', 'URL å‚æ•°ä¸­æœªæ‰¾åˆ°è™šæ‹Ÿæœº IDï¼Œè¯·ä»ä»ªè¡¨æ¿é‡æ–°è¿æ¥');
        } else if (!token) {
            showError('æœªè®¤è¯', 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', true);
        } else {
            initializeSPICE();
        }

        /**
         * Initialize SPICE connection
         */
        async function initializeSPICE() {
            try {
                updateLoadingText('æ­£åœ¨è·å–è¿æ¥ä¿¡æ¯...');

                // Fetch SPICE connection info
                const spiceInfo = await fetchSPICEInfo();

                updateLoadingText('æ­£åœ¨å¯åŠ¨ SPICE å®¢æˆ·ç«¯...');

                // Connect to SPICE
                connectSPICE(spiceInfo);

            } catch (error) {
                console.error('âŒ [SPICE Client] Initialization failed:', error);
                handleInitError(error);
            }
        }

        /**
         * Fetch SPICE connection information from API
         */
        async function fetchSPICEInfo() {
            console.log('ğŸ“ [API] Fetching SPICE connection info...');

            const response = await fetch(`${CONFIG.API_ENDPOINT}/${vmId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
            }

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || result.message || 'API è¿”å›å¤±è´¥çŠ¶æ€');
            }

            const spiceInfo = result.data;
            console.log('âœ… [API] SPICE info received');

            return spiceInfo;
        }

        /**
         * Connect to SPICE server
         */
        function connectSPICE(spiceInfo) {
            try {
                // Build SPICE WebSocket URL
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');

                // Build SPICE URI with token - use /spice/ path
                const uri = `${protocol}//${host}:${port}/spice/${vmId}?token=${encodeURIComponent(token)}`;

                console.log('ğŸ”— [SPICE] Connecting to:', uri);

                // Create SPICE connection
                sc = new SpiceHtml5.SpiceMainConn({
                    uri: uri,
                    screen_id: "spice-screen",
                    password: spiceInfo.password || '',
                    onerror: handleSpiceError,
                    onagent: handleAgentConnected
                });

                console.log('âœ… [SPICE Client] Connection initiated');

                // Show SPICE container
                elements.loadingContainer.style.display = 'none';
                elements.spiceContainer.style.display = 'block';

            } catch (error) {
                console.error('âŒ [SPICE Client] Connection failed:', error);
                throw error;
            }
        }

        /**
         * Handle SPICE error
         */
        function handleSpiceError(e) {
            console.error('âŒ [SPICE] Error:', e);
            showError('è¿æ¥é”™è¯¯', 'SPICE è¿æ¥å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥è™šæ‹ŸæœºçŠ¶æ€åé‡è¯•');
            disconnect();
        }

        /**
         * Handle agent connected
         */
        function handleAgentConnected(sc) {
            console.log('âœ… [SPICE] Agent connected');
            window.addEventListener('resize', () => SpiceHtml5.handle_resize(sc));
            window.spice_connection = sc;
            SpiceHtml5.resize_helper(sc);

            // Setup file drag and drop if supported
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                const spiceXferArea = document.createElement("div");
                spiceXferArea.setAttribute('id', 'spice-xfer-area');
                document.getElementById('spice-area').appendChild(spiceXferArea);
                document.getElementById('spice-area').addEventListener('dragover', SpiceHtml5.handle_file_dragover, false);
                document.getElementById('spice-area').addEventListener('drop', SpiceHtml5.handle_file_drop, false);
            }
        }

        /**
         * Disconnect from SPICE
         */
        function disconnect() {
            console.log('ğŸ”Œ [SPICE] Disconnecting...');
            if (sc) {
                sc.stop();
                sc = null;
            }
            goBack();
        }

        /**
         * Update loading text
         */
        function updateLoadingText(text, subtext = 'è¯·ç¨å€™') {
            elements.loadingText.textContent = text;
            elements.loadingSubtext.textContent = subtext;
        }

        /**
         * Handle initialization errors
         */
        function handleInitError(error) {
            const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';

            if (errorMsg.includes('401') || errorMsg.includes('403') || errorMsg.includes('è®¤è¯')) {
                showError('è®¤è¯å¤±è´¥', 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', true);
            } else if (errorMsg.includes('404')) {
                showError('è™šæ‹Ÿæœºä¸å­˜åœ¨', 'æœªæ‰¾åˆ°æŒ‡å®šçš„è™šæ‹Ÿæœºï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™');
            } else if (errorMsg.includes('500')) {
                showError('æœåŠ¡å™¨é”™è¯¯', 'æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } else if (errorMsg.includes('timeout') || errorMsg.includes('network')) {
                showError('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            } else {
                showError('è¿æ¥å¤±è´¥', errorMsg);
            }
        }

        /**
         * Show error message
         */
        function showError(title, message, redirectToLogin = false) {
            elements.errorMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
            elements.loadingContainer.style.display = 'none';
            elements.spiceContainer.style.display = 'none';
            elements.errorContainer.style.display = 'flex';

            if (redirectToLogin) {
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, CONFIG.REDIRECT_DELAY);
            }
        }

        /**
         * Go back to dashboard
         */
        window.goBack = function() {
            window.location.href = '/dashboard.html';
        };

        /**
         * Send Ctrl+Alt+Del
         */
        elements.ctrlAltDelButton.addEventListener('click', function() {
            if (sc) {
                SpiceHtml5.sendCtrlAltDel(sc);
                console.log('âŒ¨ï¸ [SPICE] Sent Ctrl+Alt+Del');
            }
        });

        /**
         * Disconnect button
         */
        elements.disconnectButton.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ–­å¼€è¿æ¥å—ï¼Ÿ')) {
                disconnect();
            }
        });

        /**
         * Fullscreen functionality
         */
        let isFullscreen = false;

        elements.fullscreenButton.addEventListener('click', function() {
            if (!isFullscreen) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        });

        function enterFullscreen() {
            const elem = elements.spiceContainer;

            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
            }

            console.log('ğŸ“º [SPICE] Entering fullscreen mode');
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            }

            console.log('ğŸ“º [SPICE] Exiting fullscreen mode');
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement ||
                            document.webkitFullscreenElement ||
                            document.mozFullScreenElement ||
                            document.msFullscreenElement);

            if (isFullscreen) {
                elements.fullscreenButton.textContent = 'é€€å‡ºå…¨å±';
                elements.fullscreenButton.classList.remove('success');
                elements.fullscreenButton.classList.add('danger');
                console.log('âœ… [SPICE] Fullscreen mode activated');
            } else {
                elements.fullscreenButton.textContent = 'å…¨å±';
                elements.fullscreenButton.classList.remove('danger');
                elements.fullscreenButton.classList.add('success');
                console.log('âœ… [SPICE] Fullscreen mode deactivated');
            }
        }

        // Handle window unload
        window.addEventListener('beforeunload', function() {
            if (sc) {
                sc.stop();
            }
        });
    </script>
</body>
</html>
