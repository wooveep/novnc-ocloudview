<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿæœºè¿æ¥ - SPICE</title>
    <link rel="stylesheet" type="text/css" href="/css/spice.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
        }

        #loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loading-text {
            font-size: 18px;
            font-weight: 500;
        }

        #loading-subtext {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        #error-container {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        #error-message {
            font-size: 18px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .error-back-button {
            padding: 12px 24px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .error-back-button:hover {
            background-color: #5568d3;
        }

        #spice-container {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #spice-area {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #spice-screen {
            width: 100%;
            height: 100%;
        }

        /* Adjust when in fullscreen */
        #spice-container:-webkit-full-screen #spice-area,
        #spice-container:-moz-full-screen #spice-area,
        #spice-container:fullscreen #spice-area {
            height: 100vh;
        }

        /* Toolbar trigger area */
        #toolbar-trigger {
            position: fixed;
            top: 0;
            left: 25%;
            right: 25%;
            height: 10px;
            z-index: 999;
            background: transparent;
        }

        /* Control Panel Styles - Auto-hide toolbar */
        #control-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
        }

        #control-panel.visible {
            transform: translateY(0);
        }

        .control-button {
            padding: 6px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .control-button:hover {
            background: #5568d3;
        }

        .control-button.success {
            background: #28a745;
        }

        .control-button.success:hover {
            background: #218838;
        }

        .control-button.danger {
            background: #dc3545;
        }

        .control-button.danger:hover {
            background: #c82333;
        }

        .control-spacer {
            flex: 1;
        }

        #connection-status {
            color: #28a745;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #connection-status::before {
            content: 'â—';
            font-size: 16px;
        }

        /* Fullscreen styles */
        #spice-container:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }

        #spice-container:-moz-full-screen {
            width: 100%;
            height: 100%;
        }

        #spice-container:fullscreen {
            width: 100%;
            height: 100%;
        }

        /* Diagnostic Panel */
        #diagnostic-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #diagnostic-panel h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        #diagnostic-panel h3 {
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 16px;
            color: #667eea;
        }

        #diagnostic-panel pre {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        #diagnostic-panel .diagnostic-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        #diagnostic-panel .diagnostic-label {
            color: #aaa;
            font-size: 12px;
        }

        #diagnostic-panel .diagnostic-value {
            font-family: monospace;
            font-size: 13px;
        }

        #diagnostic-panel .warning-item {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        #diagnostic-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        #diagnostic-panel .export-btn {
            margin-top: 15px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #diagnostic-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
        }
    </style>

    <!-- ES2015/ES6 modules polyfill -->
    <script type="module">
        window._spice_has_module_support = true;
    </script>
    <script>
        window.addEventListener("load", function() {
            if (window._spice_has_module_support) return;
            var loader = document.createElement("script");
            loader.src = "/spice-html5/src/thirdparty/browser-es-module-loader/src/browser-es-module-loader.js";
            document.head.appendChild(loader);
        });
    </script>
</head>
<body>
    <!-- Loading State -->
    <div id="loading-container">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨è¿æ¥è™šæ‹Ÿæœº...</div>
        <div id="loading-subtext">è¯·ç¨å€™</div>
    </div>

    <!-- Error State -->
    <div id="error-container">
        <div class="error-icon">âš ï¸</div>
        <div id="error-message"></div>
        <button class="error-back-button" onclick="goBack()">è¿”å›ä»ªè¡¨æ¿</button>
    </div>

    <!-- SPICE Container -->
    <div id="spice-container">
        <div id="toolbar-trigger"></div>
        <div id="control-panel">
            <span id="connection-status">å·²è¿æ¥</span>
            <button class="control-button" id="ctrlAltDelButton">Ctrl+Alt+Del</button>
            <button class="control-button" id="diagnosticButton">åè®®è¯Šæ–­</button>
            <button class="control-button success" id="fullscreenButton">å…¨å±</button>
            <div class="control-spacer"></div>
            <button class="control-button danger" id="disconnectButton">æ–­å¼€è¿æ¥</button>
        </div>
        <div id="spice-area">
            <div id="spice-screen" class="spice-screen"></div>
        </div>
    </div>

    <!-- Diagnostic Panel -->
    <div id="diagnostic-overlay"></div>
    <div id="diagnostic-panel">
        <button class="close-btn" onclick="closeDiagnostic()">âœ•</button>
        <h2>ğŸ” SPICE åè®®è¯Šæ–­</h2>
        <div id="diagnostic-content"></div>
        <div style="margin-top: 15px;">
            <button class="export-btn" onclick="exportDiagnosticLog()">å¯¼å‡ºè¯Šæ–­æ—¥å¿—</button>
            <button class="export-btn" onclick="forceInputFocus()" style="margin-left: 10px; background: #28a745;">ä¿®å¤è¾“å…¥ç„¦ç‚¹</button>
        </div>
    </div>

    <script type="module">
        import * as SpiceHtml5 from './spice-html5/src/main.js';

        'use strict';

        // Configuration
        const CONFIG = {
            API_ENDPOINT: '/api/spice/connect',
            REDIRECT_DELAY: 2000,
            DEFAULT_SETTINGS: {
                // SPICE settings can be configured here
            }
        };

        // DOM Elements
        const elements = {
            loadingContainer: document.getElementById('loading-container'),
            loadingText: document.getElementById('loading-text'),
            loadingSubtext: document.getElementById('loading-subtext'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            spiceContainer: document.getElementById('spice-container'),
            ctrlAltDelButton: document.getElementById('ctrlAltDelButton'),
            fullscreenButton: document.getElementById('fullscreenButton'),
            disconnectButton: document.getElementById('disconnectButton'),
            connectionStatus: document.getElementById('connection-status')
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const vmId = urlParams.get('id');
        const token = urlParams.get('token') || localStorage.getItem('token');
        const gpuType = urlParams.get('gpuType') || ''; // vGPU type (e.g., "nvidia-...")

        let sc = null; // SPICE connection

        // Initialize
        console.log('ğŸš€ [SPICE Client] Initializing...');
        console.log(`   VM ID: ${vmId || 'Not provided'}`);
        console.log(`   Token source: ${urlParams.get('token') ? 'URL parameter' : 'localStorage'}`);
        console.log(`   GPU Type: ${gpuType || 'Not specified (standard VM)'}`);

        // Check if this is a vGPU VM
        const isVGPU = gpuType && gpuType.toLowerCase().includes('nvidia');
        if (isVGPU) {
            console.log('ğŸ® [vGPU] Detected NVIDIA vGPU VM - will adjust resolution strategy');
        }

        // Validate inputs
        if (!vmId) {
            showError('ç¼ºå°‘è™šæ‹Ÿæœº ID', 'URL å‚æ•°ä¸­æœªæ‰¾åˆ°è™šæ‹Ÿæœº IDï¼Œè¯·ä»ä»ªè¡¨æ¿é‡æ–°è¿æ¥');
        } else if (!token) {
            showError('æœªè®¤è¯', 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', true);
        } else {
            initializeSPICE();
        }

        /**
         * Initialize SPICE connection
         */
        async function initializeSPICE() {
            try {
                updateLoadingText('æ­£åœ¨è·å–è¿æ¥ä¿¡æ¯...');

                // Fetch SPICE connection info
                const spiceInfo = await fetchSPICEInfo();

                updateLoadingText('æ­£åœ¨å¯åŠ¨ SPICE å®¢æˆ·ç«¯...');

                // Connect to SPICE
                connectSPICE(spiceInfo);

            } catch (error) {
                console.error('âŒ [SPICE Client] Initialization failed:', error);
                handleInitError(error);
            }
        }

        /**
         * Fetch SPICE connection information from API
         */
        async function fetchSPICEInfo() {
            console.log('ğŸ“ [API] Fetching SPICE connection info...');

            const response = await fetch(`${CONFIG.API_ENDPOINT}/${vmId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
            }

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || result.message || 'API è¿”å›å¤±è´¥çŠ¶æ€');
            }

            const spiceInfo = result.data;
            console.log('âœ… [API] SPICE info received');

            return spiceInfo;
        }

        /**
         * Connect to SPICE server
         */
        function connectSPICE(spiceInfo) {
            try {
                // Build SPICE WebSocket URL
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');

                // Build SPICE URI with token - use /spice/ path
                const uri = `${protocol}//${host}:${port}/spice/${vmId}?token=${encodeURIComponent(token)}`;

                console.log('ğŸ”— [SPICE] Connecting to:', uri);

                // Create SPICE connection
                sc = new SpiceHtml5.SpiceMainConn({
                    uri: uri,
                    screen_id: "spice-screen",
                    password: spiceInfo.password || '',
                    onerror: handleSpiceError,
                    onagent: handleAgentConnected,
                    onsuccess: handleConnectionSuccess
                });

                // Set vGPU flag for resolution handling
                sc.is_vgpu = isVGPU;
                sc.gpu_type = gpuType;

                console.log('âœ… [SPICE Client] Connection initiated');

                // Show SPICE container
                elements.loadingContainer.style.display = 'none';
                elements.spiceContainer.style.display = 'block';

                // Setup resize handler and initial resize (don't wait for agent)
                window.spice_connection = sc;
                setTimeout(function() {
                    if (sc && sc.display && sc.display.surfaces && sc.display.surfaces[sc.display.primary_surface]) {
                        console.log('ğŸ–¥ï¸  [SPICE] Setting up display and input handlers');
                        window.addEventListener('resize', SpiceHtml5.handle_resize);

                        // For vGPU VMs, trigger resolution adjustment more aggressively
                        if (sc.is_vgpu) {
                            console.log('ğŸ® [vGPU] Initial resolution adjustment for vGPU VM');
                            SpiceHtml5.resize_helper(sc);

                            // Trigger again after display is fully ready
                            setTimeout(() => {
                                console.log('ğŸ® [vGPU] Secondary resolution adjustment for vGPU VM');
                                SpiceHtml5.resize_helper(sc);
                            }, 2000);
                        } else {
                            SpiceHtml5.resize_helper(sc);
                        }

                        // Ensure canvas has focus for keyboard input
                        var canvas = sc.display.surfaces[sc.display.primary_surface].canvas;
                        if (canvas) {
                            canvas.focus();
                            console.log('âœ… [SPICE] Canvas focused for input');
                        }
                    }
                }, 1000); // Give time for display channel to initialize

            } catch (error) {
                console.error('âŒ [SPICE Client] Connection failed:', error);
                throw error;
            }
        }

        /**
         * Handle SPICE error
         */
        function handleSpiceError(e) {
            console.error('âŒ [SPICE] Error:', e);
            showError('è¿æ¥é”™è¯¯', 'SPICE è¿æ¥å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥è™šæ‹ŸæœºçŠ¶æ€åé‡è¯•');
            disconnect();
        }

        /**
         * Handle connection success
         */
        function handleConnectionSuccess(m) {
            console.log('âœ… [SPICE] Connection successful:', m);
            elements.connectionStatus.textContent = 'å·²è¿æ¥';
            elements.connectionStatus.style.color = '#28a745';

            // Check if agent is connected
            if (sc && sc.main_init && sc.main_init.agent_connected) {
                console.log('âœ… [SPICE] Agent is connected');

                // For vGPU VMs with agent connected, trigger resolution adjustment
                if (sc.is_vgpu) {
                    console.log('ğŸ® [vGPU] Connection successful with agent - will trigger resolution adjustment');
                }
            } else {
                console.log('âš ï¸  [SPICE] Agent not connected - some features may be limited');
                console.log('   - Auto-resize: Not available');
                console.log('   - Clipboard sharing: Not available');
                console.log('   - File transfer: Not available');
                console.log('   - Keyboard/Mouse input: Should still work');

                // For vGPU VMs without agent, warn that resolution adjustment won't work
                if (sc && sc.is_vgpu) {
                    console.warn('âš ï¸  [vGPU] SPICE Agent not connected - resolution adjustment will NOT work');
                    console.warn('   Please install SPICE Guest Tools in the VM for vGPU resolution adjustment');
                }
            }
        }

        /**
         * Handle agent connected
         */
        function handleAgentConnected(sc) {
            console.log('âœ… [SPICE] Agent connected');
            // Note: resize listener already added in connection setup
            window.spice_connection = sc;

            // For vGPU VMs, trigger immediate resolution adjustment when agent connects
            if (sc.is_vgpu) {
                console.log('ğŸ® [vGPU] Agent connected - triggering resolution adjustment');
                SpiceHtml5.resize_helper(sc);

                // Trigger again after a short delay to ensure it takes effect
                // This is important for vGPU VMs as the agent needs time to process the request
                setTimeout(() => {
                    console.log('ğŸ® [vGPU] Re-triggering resolution adjustment for vGPU VM');
                    SpiceHtml5.resize_helper(sc);
                }, 1500);
            } else {
                SpiceHtml5.resize_helper(sc);
            }

            // Setup file drag and drop if supported
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                const spiceXferArea = document.createElement("div");
                spiceXferArea.setAttribute('id', 'spice-xfer-area');
                document.getElementById('spice-area').appendChild(spiceXferArea);
                document.getElementById('spice-area').addEventListener('dragover', SpiceHtml5.handle_file_dragover, false);
                document.getElementById('spice-area').addEventListener('drop', SpiceHtml5.handle_file_drop, false);
            }
        }

        /**
         * Disconnect from SPICE
         */
        function disconnect() {
            console.log('ğŸ”Œ [SPICE] Disconnecting...');
            if (sc) {
                sc.stop();
                sc = null;
            }
            goBack();
        }

        /**
         * Update loading text
         */
        function updateLoadingText(text, subtext = 'è¯·ç¨å€™') {
            elements.loadingText.textContent = text;
            elements.loadingSubtext.textContent = subtext;
        }

        /**
         * Handle initialization errors
         */
        function handleInitError(error) {
            const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';

            if (errorMsg.includes('401') || errorMsg.includes('403') || errorMsg.includes('è®¤è¯')) {
                showError('è®¤è¯å¤±è´¥', 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', true);
            } else if (errorMsg.includes('404')) {
                showError('è™šæ‹Ÿæœºä¸å­˜åœ¨', 'æœªæ‰¾åˆ°æŒ‡å®šçš„è™šæ‹Ÿæœºï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™');
            } else if (errorMsg.includes('500')) {
                showError('æœåŠ¡å™¨é”™è¯¯', 'æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } else if (errorMsg.includes('timeout') || errorMsg.includes('network')) {
                showError('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            } else {
                showError('è¿æ¥å¤±è´¥', errorMsg);
            }
        }

        /**
         * Show error message
         */
        function showError(title, message, redirectToLogin = false) {
            elements.errorMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
            elements.loadingContainer.style.display = 'none';
            elements.spiceContainer.style.display = 'none';
            elements.errorContainer.style.display = 'flex';

            if (redirectToLogin) {
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, CONFIG.REDIRECT_DELAY);
            }
        }

        /**
         * Go back to dashboard
         */
        window.goBack = function() {
            window.location.href = '/dashboard.html';
        };

        /**
         * Send Ctrl+Alt+Del
         */
        elements.ctrlAltDelButton.addEventListener('click', function() {
            if (sc) {
                SpiceHtml5.sendCtrlAltDel(sc);
                console.log('âŒ¨ï¸ [SPICE] Sent Ctrl+Alt+Del');
            }
        });

        /**
         * Disconnect button
         */
        elements.disconnectButton.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ–­å¼€è¿æ¥å—ï¼Ÿ')) {
                disconnect();
            }
        });

        /**
         * Fullscreen functionality
         */
        let isFullscreen = false;

        elements.fullscreenButton.addEventListener('click', function() {
            if (!isFullscreen) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        });

        function enterFullscreen() {
            const elem = elements.spiceContainer;

            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
            }

            console.log('ğŸ“º [SPICE] Entering fullscreen mode');
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            }

            console.log('ğŸ“º [SPICE] Exiting fullscreen mode');
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement ||
                            document.webkitFullscreenElement ||
                            document.mozFullScreenElement ||
                            document.msFullscreenElement);

            if (isFullscreen) {
                elements.fullscreenButton.textContent = 'é€€å‡ºå…¨å±';
                elements.fullscreenButton.classList.remove('success');
                elements.fullscreenButton.classList.add('danger');
                console.log('âœ… [SPICE] Fullscreen mode activated');
            } else {
                elements.fullscreenButton.textContent = 'å…¨å±';
                elements.fullscreenButton.classList.remove('danger');
                elements.fullscreenButton.classList.add('success');
                console.log('âœ… [SPICE] Fullscreen mode deactivated');
            }
        }

        // Toolbar auto-show/hide with 2s delay
        let toolbarShowTimer = null;
        let toolbarHideTimer = null;
        const toolbarTrigger = document.getElementById('toolbar-trigger');
        const controlPanel = document.getElementById('control-panel');

        function showToolbar() {
            if (toolbarHideTimer) {
                clearTimeout(toolbarHideTimer);
                toolbarHideTimer = null;
            }
            controlPanel.classList.add('visible');
        }

        function hideToolbar() {
            controlPanel.classList.remove('visible');
        }

        // Trigger area hover - show after 2s delay
        toolbarTrigger.addEventListener('mouseenter', function() {
            if (toolbarShowTimer) {
                clearTimeout(toolbarShowTimer);
            }
            toolbarShowTimer = setTimeout(function() {
                showToolbar();
            }, 2000); // 2ç§’å»¶è¿Ÿ
        });

        toolbarTrigger.addEventListener('mouseleave', function() {
            if (toolbarShowTimer) {
                clearTimeout(toolbarShowTimer);
                toolbarShowTimer = null;
            }
        });

        // Control panel hover - keep visible
        controlPanel.addEventListener('mouseenter', function() {
            if (toolbarHideTimer) {
                clearTimeout(toolbarHideTimer);
                toolbarHideTimer = null;
            }
            if (toolbarShowTimer) {
                clearTimeout(toolbarShowTimer);
                toolbarShowTimer = null;
            }
            showToolbar();
        });

        controlPanel.addEventListener('mouseleave', function() {
            if (toolbarHideTimer) {
                clearTimeout(toolbarHideTimer);
            }
            toolbarHideTimer = setTimeout(function() {
                hideToolbar();
            }, 500); // å»¶è¿Ÿéšè—ï¼Œé¿å…é¼ æ ‡å¿«é€Ÿç§»åŠ¨æ—¶é—ªçƒ
        });

        // Handle window unload
        window.addEventListener('beforeunload', function() {
            if (sc) {
                sc.stop();
            }
        });

        /**
         * Diagnostic functionality
         */
        let diagnosticLogs = [];

        // Override console methods to capture logs
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        console.log = function(...args) {
            diagnosticLogs.push({ type: 'log', time: new Date().toISOString(), message: args.join(' ') });
            originalConsoleLog.apply(console, args);
        };

        console.warn = function(...args) {
            diagnosticLogs.push({ type: 'warn', time: new Date().toISOString(), message: args.join(' ') });
            originalConsoleWarn.apply(console, args);
        };

        console.error = function(...args) {
            diagnosticLogs.push({ type: 'error', time: new Date().toISOString(), message: args.join(' ') });
            originalConsoleError.apply(console, args);
        };

        // Diagnostic button handler
        document.getElementById('diagnosticButton').addEventListener('click', function() {
            showDiagnosticPanel();
        });

        function showDiagnosticPanel() {
            const content = document.getElementById('diagnostic-content');
            const overlay = document.getElementById('diagnostic-overlay');
            const panel = document.getElementById('diagnostic-panel');

            let html = '<h3>ğŸ“Š è¿æ¥ä¿¡æ¯</h3>';
            html += '<div class="diagnostic-item">';
            html += '<div class="diagnostic-label">è™šæ‹Ÿæœº ID:</div>';
            html += '<div class="diagnostic-value">' + (vmId || 'N/A') + '</div>';
            html += '</div>';

            if (sc) {
                html += '<div class="diagnostic-item">';
                html += '<div class="diagnostic-label">è¿æ¥çŠ¶æ€:</div>';
                html += '<div class="diagnostic-value">' + (sc.state || 'unknown') + '</div>';
                html += '</div>';

                if (sc.main_init) {
                    html += '<h3>ğŸ”Œ SPICE åè®®ä¿¡æ¯</h3>';
                    html += '<div class="diagnostic-item">';
                    html += '<div class="diagnostic-label">Session ID:</div>';
                    html += '<div class="diagnostic-value">' + sc.main_init.session_id + '</div>';
                    html += '</div>';
                    html += '<div class="diagnostic-item">';
                    html += '<div class="diagnostic-label">é¼ æ ‡æ¨¡å¼:</div>';
                    html += '<div class="diagnostic-value">' + sc.main_init.current_mouse_mode;
                    html += ' (' + (sc.main_init.current_mouse_mode === 1 ? 'Server' : 'Client') + ')</div>';
                    html += '</div>';
                    html += '<div class="diagnostic-item">';
                    html += '<div class="diagnostic-label">Agent è¿æ¥:</div>';
                    html += '<div class="diagnostic-value">' + (sc.main_init.agent_connected ? 'âœ… æ˜¯' : 'âŒ å¦') + '</div>';
                    html += '</div>';

                    // Show agent warning if not connected
                    if (!sc.main_init.agent_connected) {
                        html += '<div class="warning-item">';
                        html += '<strong>âš ï¸ SPICE Agent æœªè¿æ¥</strong><br>';
                        html += 'ç¼ºå°‘çš„åŠŸèƒ½ï¼š<br>';
                        html += 'â€¢ è‡ªåŠ¨åˆ†è¾¨ç‡è°ƒæ•´<br>';
                        html += 'â€¢ å‰ªè´´æ¿å…±äº«<br>';
                        html += 'â€¢ æ–‡ä»¶æ‹–æ”¾ä¼ è¾“<br><br>';
                        html += '<strong>è§£å†³æ–¹æ³•ï¼š</strong><br>';
                        html += '1. ç¡®ä¿è™šæ‹Ÿæœºä¸­å·²å®‰è£… SPICE Guest Tools / qemu-guest-agent<br>';
                        html += '2. åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨ SPICE vdagent æœåŠ¡<br>';
                        html += '3. å¯¹äº Windows: å®‰è£… spice-guest-tools.exe<br>';
                        html += '4. å¯¹äº Linux: å®‰è£…å¹¶å¯åŠ¨ spice-vdagent åŒ…';
                        html += '</div>';
                    }
                }

                // Show channel information
                html += '<h3>ğŸ“¡ é€šé“ä¿¡æ¯</h3>';
                if (sc.display) {
                    html += '<div class="diagnostic-item">';
                    html += '<div class="diagnostic-label">æ˜¾ç¤ºé€šé“:</div>';
                    html += '<div class="diagnostic-value">çŠ¶æ€: ' + (sc.display.state || 'unknown');
                    if (sc.display.surfaces && sc.display.surfaces.length > 0) {
                        html += ', è¡¨é¢æ•°: ' + sc.display.surfaces.filter(s => s !== undefined).length;
                    }
                    html += '</div></div>';

                    // Check if canvas has event listeners
                    if (sc.display.primary_surface !== undefined && sc.display.surfaces[sc.display.primary_surface]) {
                        const canvas = sc.display.surfaces[sc.display.primary_surface].canvas;
                        html += '<div class="diagnostic-item">';
                        html += '<div class="diagnostic-label">Canvas çŠ¶æ€:</div>';
                        html += '<div class="diagnostic-value">';
                        html += 'ID: ' + (canvas.id || 'N/A') + ', ';
                        html += 'tabIndex: ' + (canvas.tabIndex || 'N/A') + ', ';
                        html += 'isFocused: ' + (document.activeElement === canvas ? 'âœ…' : 'âŒ');
                        html += '</div></div>';

                        if (document.activeElement !== canvas) {
                            html += '<div class="warning-item">';
                            html += '<strong>âš ï¸ Canvas æœªè·å¾—ç„¦ç‚¹</strong><br>';
                            html += 'è¿™å¯èƒ½å¯¼è‡´é”®ç›˜è¾“å…¥æ— å“åº”ã€‚<br>';
                            html += '<strong>è§£å†³æ–¹æ³•ï¼š</strong>ç‚¹å‡»è™šæ‹Ÿæœºå±å¹•åŒºåŸŸä»¥æ¿€æ´»è¾“å…¥ã€‚';
                            html += '</div>';
                        }
                    }
                }
                if (sc.inputs) {
                    html += '<div class="diagnostic-item">';
                    html += '<div class="diagnostic-label">è¾“å…¥é€šé“:</div>';
                    html += '<div class="diagnostic-value">çŠ¶æ€: ' + (sc.inputs.state || 'unknown');
                    if (sc.inputs.mouse_mode !== undefined) {
                        html += ', é¼ æ ‡æ¨¡å¼: ' + sc.inputs.mouse_mode;
                    }
                    html += '</div>';
                    html += '</div>';
                }
                if (sc.cursor) {
                    html += '<div class="diagnostic-item">';
                    html += '<div class="diagnostic-label">å…‰æ ‡é€šé“:</div>';
                    html += '<div class="diagnostic-value">çŠ¶æ€: ' + (sc.cursor.state || 'unknown') + '</div>';
                    html += '</div>';
                }

                // Show warnings
                html += '<h3>âš ï¸ è­¦å‘Šä¿¡æ¯</h3>';
                const warnings = [];
                if (sc.display && sc.display.warnings) {
                    for (let key in sc.display.warnings) {
                        if (sc.display.warnings[key]) {
                            warnings.push('Display: æœªå®ç°çš„æ¶ˆæ¯ç±»å‹ ' + key);
                        }
                    }
                }
                if (sc.inputs && sc.inputs.warnings) {
                    for (let key in sc.inputs.warnings) {
                        if (sc.inputs.warnings[key]) {
                            warnings.push('Inputs: æœªå®ç°çš„æ¶ˆæ¯ç±»å‹ ' + key);
                        }
                    }
                }

                if (warnings.length > 0) {
                    warnings.forEach(w => {
                        html += '<div class="warning-item">' + w + '</div>';
                    });
                } else {
                    html += '<div class="diagnostic-item">æ— è­¦å‘Š</div>';
                }
            } else {
                html += '<div class="diagnostic-item"><div class="diagnostic-value">æœªè¿æ¥</div></div>';
            }

            // Show recent logs
            html += '<h3>ğŸ“ æœ€è¿‘æ—¥å¿— (æœ€å20æ¡)</h3>';
            html += '<pre>';
            const recentLogs = diagnosticLogs.slice(-20);
            recentLogs.forEach(log => {
                const icon = log.type === 'error' ? 'âŒ' : (log.type === 'warn' ? 'âš ï¸' : 'â„¹ï¸');
                html += icon + ' [' + new Date(log.time).toLocaleTimeString() + '] ' + log.message + '\\n';
            });
            html += '</pre>';

            content.innerHTML = html;
            overlay.style.display = 'block';
            panel.style.display = 'block';
        }

        window.closeDiagnostic = function() {
            document.getElementById('diagnostic-overlay').style.display = 'none';
            document.getElementById('diagnostic-panel').style.display = 'none';
        };

        window.exportDiagnosticLog = function() {
            const diagnosticData = {
                timestamp: new Date().toISOString(),
                vmId: vmId,
                connection: sc ? {
                    state: sc.state,
                    main_init: sc.main_init,
                    channels: {
                        display: sc.display ? { state: sc.display.state, warnings: sc.display.warnings } : null,
                        inputs: sc.inputs ? { state: sc.inputs.state, warnings: sc.inputs.warnings } : null,
                        cursor: sc.cursor ? { state: sc.cursor.state, warnings: sc.cursor.warnings } : null
                    }
                } : null,
                logs: diagnosticLogs
            };

            const dataStr = JSON.stringify(diagnosticData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = 'spice-diagnostic-' + new Date().toISOString().replace(/:/g, '-') + '.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            console.log('âœ… [Diagnostic] Log exported');
        };

        // Close diagnostic panel when clicking overlay
        document.getElementById('diagnostic-overlay').addEventListener('click', function() {
            closeDiagnostic();
        });

        /**
         * Force input focus on canvas
         */
        window.forceInputFocus = function() {
            if (sc && sc.display && sc.display.primary_surface !== undefined && sc.display.surfaces[sc.display.primary_surface]) {
                const canvas = sc.display.surfaces[sc.display.primary_surface].canvas;
                if (canvas) {
                    canvas.focus();
                    console.log('âœ… [Diagnostic] Canvas focus forced');

                    // Also try to trigger resize in case that helps
                    if (typeof SpiceHtml5.resize_helper === 'function') {
                        SpiceHtml5.resize_helper(sc);
                        console.log('âœ… [Diagnostic] Resize helper called');
                    }

                    alert('å·²å°è¯•ä¿®å¤è¾“å…¥ç„¦ç‚¹ã€‚å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·ï¼š\n1. åˆ·æ–°é¡µé¢é‡æ–°è¿æ¥\n2. ç¡®ä¿è™šæ‹Ÿæœºä¸­å·²å®‰è£… SPICE Guest Tools\n3. ç‚¹å‡»è™šæ‹Ÿæœºå±å¹•åŒºåŸŸæ¿€æ´»è¾“å…¥');
                } else {
                    alert('æ— æ³•æ‰¾åˆ°ç”»å¸ƒå…ƒç´ ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                }
            } else {
                alert('SPICE è¿æ¥æœªå°±ç»ªã€‚è¯·ç­‰å¾…è¿æ¥å»ºç«‹åé‡è¯•ã€‚');
            }
        };
    </script>
</body>
</html>
