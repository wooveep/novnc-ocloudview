<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿæœºè¿æ¥ - noVNC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
        }

        #loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loading-text {
            font-size: 18px;
            font-weight: 500;
        }

        #loading-subtext {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        #error-container {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        #error-message {
            font-size: 18px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .error-back-button {
            padding: 12px 24px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .error-back-button:hover {
            background-color: #5568d3;
        }

        #vnc-container {
            display: none;
            width: 100vw;
            height: 100vh;
        }

        #vnc-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loading-container">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨è¿æ¥è™šæ‹Ÿæœº...</div>
        <div id="loading-subtext">è¯·ç¨å€™</div>
    </div>

    <!-- Error State -->
    <div id="error-container">
        <div class="error-icon">âš ï¸</div>
        <div id="error-message"></div>
        <button class="error-back-button" onclick="goBack()">è¿”å›ä»ªè¡¨æ¿</button>
    </div>

    <!-- VNC Container -->
    <div id="vnc-container">
        <iframe id="vnc-iframe" src="" allow="clipboard-read; clipboard-write" sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups"></iframe>
    </div>

    <script>
        'use strict';

        // Configuration
        const CONFIG = {
            API_ENDPOINT: '/api/vnc/connect',
            REDIRECT_DELAY: 2000,
            NOVNC_BASE_PATH: '/novnc/vnc.html',
            DEFAULT_SETTINGS: {
                autoconnect: 'true',
                resize: 'scale',
                reconnect: 'true',
                reconnect_delay: '5000',
                quality: '6',
                compression: '2'
            }
        };

        // DOM Elements
        const elements = {
            loadingContainer: document.getElementById('loading-container'),
            loadingText: document.getElementById('loading-text'),
            loadingSubtext: document.getElementById('loading-subtext'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            vncContainer: document.getElementById('vnc-container'),
            vncIframe: document.getElementById('vnc-iframe')
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const vmId = urlParams.get('id');
        const token = urlParams.get('token') || localStorage.getItem('token');

        // Initialize
        console.log('ğŸš€ [VNC Client] Initializing...');
        console.log(`   VM ID: ${vmId || 'Not provided'}`);
        console.log(`   Token source: ${urlParams.get('token') ? 'URL parameter' : 'localStorage'}`);

        // Validate inputs
        if (!vmId) {
            showError('ç¼ºå°‘è™šæ‹Ÿæœº ID', 'URL å‚æ•°ä¸­æœªæ‰¾åˆ°è™šæ‹Ÿæœº IDï¼Œè¯·ä»ä»ªè¡¨æ¿é‡æ–°è¿æ¥');
        } else if (!token) {
            showError('æœªè®¤è¯', 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', true);
        } else {
            initializeVNC();
        }

        /**
         * Initialize VNC connection
         */
        async function initializeVNC() {
            try {
                updateLoadingText('æ­£åœ¨è·å–è¿æ¥ä¿¡æ¯...');

                // Fetch VNC connection info
                const vncInfo = await fetchVNCInfo();

                updateLoadingText('æ­£åœ¨å¯åŠ¨ noVNC å®¢æˆ·ç«¯...');

                // Build noVNC URL
                const noVNCUrl = buildNoVNCUrl(vncInfo);

                console.log('âœ… [VNC Client] Initialization complete');
                console.log(`   Launching noVNC: ${noVNCUrl.split('#')[0]}`);

                // Load noVNC
                loadNoVNC(noVNCUrl);

            } catch (error) {
                console.error('âŒ [VNC Client] Initialization failed:', error);
                handleInitError(error);
            }
        }

        /**
         * Fetch VNC connection information from API
         */
        async function fetchVNCInfo() {
            console.log('ğŸ“ [API] Fetching VNC connection info...');

            const response = await fetch(`${CONFIG.API_ENDPOINT}/${vmId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
            }

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || result.message || 'API è¿”å›å¤±è´¥çŠ¶æ€');
            }

            const vncInfo = result.data;
            console.log('âœ… [API] VNC info received');
            console.log(`   WebSocket URL: ${vncInfo.websocketUrl}`);
            console.log(`   Has password: ${!!vncInfo.password}`);

            return vncInfo;
        }

        /**
         * Build noVNC URL with parameters
         */
        function buildNoVNCUrl(vncInfo) {
            const params = new URLSearchParams();

            // Extract WebSocket path (noVNC adds protocol automatically)
            const wsUrl = new URL(vncInfo.websocketUrl);
            const pathWithToken = `${wsUrl.pathname}?token=${encodeURIComponent(token)}`;

            console.log('ğŸ”— [noVNC] Building connection URL');
            console.log(`   WebSocket path: ${pathWithToken}`);

            // Set path and password
            params.set('path', pathWithToken);
            if (vncInfo.password) {
                params.set('password', vncInfo.password);
            }

            // Apply default settings
            Object.entries(CONFIG.DEFAULT_SETTINGS).forEach(([key, value]) => {
                params.set(key, value);
            });

            return `${CONFIG.NOVNC_BASE_PATH}#${params.toString()}`;
        }

        /**
         * Load noVNC in iframe
         */
        function loadNoVNC(url) {
            elements.vncIframe.src = url;
            elements.loadingContainer.style.display = 'none';
            elements.vncContainer.style.display = 'block';

            console.log('âœ… [VNC Client] noVNC loaded successfully');
        }

        /**
         * Update loading text
         */
        function updateLoadingText(text, subtext = 'è¯·ç¨å€™') {
            elements.loadingText.textContent = text;
            elements.loadingSubtext.textContent = subtext;
        }

        /**
         * Handle initialization errors
         */
        function handleInitError(error) {
            const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';

            if (errorMsg.includes('401') || errorMsg.includes('403') || errorMsg.includes('è®¤è¯')) {
                showError('è®¤è¯å¤±è´¥', 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', true);
            } else if (errorMsg.includes('404')) {
                showError('è™šæ‹Ÿæœºä¸å­˜åœ¨', 'æœªæ‰¾åˆ°æŒ‡å®šçš„è™šæ‹Ÿæœºï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™');
            } else if (errorMsg.includes('500')) {
                showError('æœåŠ¡å™¨é”™è¯¯', 'æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } else if (errorMsg.includes('timeout') || errorMsg.includes('network')) {
                showError('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            } else {
                showError('è¿æ¥å¤±è´¥', errorMsg);
            }
        }

        /**
         * Show error message
         */
        function showError(title, message, redirectToLogin = false) {
            elements.errorMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
            elements.loadingContainer.style.display = 'none';
            elements.errorContainer.style.display = 'flex';

            if (redirectToLogin) {
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, CONFIG.REDIRECT_DELAY);
            }
        }

        /**
         * Go back to dashboard
         */
        function goBack() {
            window.location.href = '/dashboard.html';
        }

        // Handle iframe errors
        elements.vncIframe.addEventListener('error', (e) => {
            console.error('âŒ [VNC Client] iframe load error:', e);
            showError('åŠ è½½å¤±è´¥', 'noVNC å®¢æˆ·ç«¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        });
    </script>
</body>
</html>
