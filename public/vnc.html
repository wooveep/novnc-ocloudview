<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿œç¨‹æ¡Œé¢ - noVNC Cloud Desktop</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            background: #1a1a1a;
            overflow: hidden;
            height: 100vh;
        }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .vnc-toolbar {
            background: #2c2c2c;
            border-bottom: 1px solid #444;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .toolbar-btn {
            padding: 8px 15px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toolbar-btn:hover {
            background: #555;
        }
        
        .toolbar-btn.danger {
            background: #d32f2f;
        }
        
        .toolbar-btn.danger:hover {
            background: #f44336;
        }
        
        .control-panel {
            position: fixed;
            top: 60px;
            right: -300px;
            width: 300px;
            height: calc(100vh - 60px);
            background: #2c2c2c;
            border-left: 1px solid #444;
            transition: right 0.3s;
            z-index: 100;
            overflow-y: auto;
        }
        
        .control-panel.open {
            right: 0;
        }
        
        .panel-section {
            padding: 15px;
            border-bottom: 1px solid #444;
        }
        
        .panel-title {
            color: #aaa;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="vnc-page">
    <div id="app">
        <div class="vnc-toolbar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="color: #fff; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px; font-weight: 500;" id="vmName">è™šæ‹Ÿæœº</span>
                    <div style="display: flex; align-items: center; gap: 5px; padding: 5px 12px; 
                                background: #333; border-radius: 20px; font-size: 12px;">
                        <div class="status-dot connecting" id="statusDot"></div>
                        <span id="statusText">è¿æ¥ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="toolbar-btn" onclick="toggleControlPanel()">âš™ï¸ è®¾ç½®</button>
                <button class="toolbar-btn" onclick="sendCtrlAltDel()">Ctrl+Alt+Del</button>
                <button class="toolbar-btn" onclick="toggleFullscreen()">ğŸ”³ å…¨å±</button>
                <button class="toolbar-btn danger" onclick="disconnect()">æ–­å¼€è¿æ¥</button>
            </div>
        </div>

        <div id="vnc-container">
            <div id="vnc-screen" style="width: 100%; height: 100%;"></div>
            
            <div class="loading-overlay show" id="loadingScreen">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div id="loadingText" style="color: #fff; font-size: 16px;">æ­£åœ¨è¿æ¥åˆ°è¿œç¨‹æ¡Œé¢...</div>
                </div>
            </div>
        </div>

        <div class="control-panel" id="controlPanel">
            <div style="padding: 15px; background: #333; color: #fff; font-size: 16px; font-weight: 500; 
                        display: flex; justify-content: space-between; align-items: center;">
                <span>è¿æ¥è®¾ç½®</span>
                <button onclick="toggleControlPanel()" 
                        style="background: none; border: none; color: #fff; font-size: 20px; cursor: pointer;">Ã—</button>
            </div>

            <div class="panel-section">
                <div class="panel-title">æ˜¾ç¤ºè®¾ç½®</div>
                
                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; font-size: 14px; margin-bottom: 5px; display: block;">ç¼©æ”¾æ¨¡å¼</label>
                    <select id="scalingMode" onchange="updateScaling()" 
                            style="width: 100%; padding: 8px; background: #444; border: 1px solid #555; 
                                   border-radius: 4px; color: #fff; font-size: 14px;">
                        <option value="off">å…³é—­</option>
                        <option value="scale" selected>è‡ªåŠ¨ç¼©æ”¾</option>
                        <option value="remote">è¿œç¨‹è°ƒæ•´</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="color: #ccc; font-size: 14px; margin-bottom: 5px; display: block;">å›¾åƒè´¨é‡</label>
                    <select id="quality" onchange="updateQuality()"
                            style="width: 100%; padding: 8px; background: #444; border: 1px solid #555; 
                                   border-radius: 4px; color: #fff; font-size: 14px;">
                        <option value="0">è‡ªåŠ¨</option>
                        <option value="2">ä½</option>
                        <option value="6" selected>ä¸­</option>
                        <option value="9">é«˜</option>
                    </select>
                </div>

                <div>
                    <label style="color: #ccc; font-size: 14px; margin-bottom: 5px; display: block;">å‹ç¼©çº§åˆ«</label>
                    <select id="compression" onchange="updateCompression()"
                            style="width: 100%; padding: 8px; background: #444; border: 1px solid #555; 
                                   border-radius: 4px; color: #fff; font-size: 14px;">
                        <option value="0">å…³é—­</option>
                        <option value="2" selected>é»˜è®¤</option>
                        <option value="9">æœ€å¤§</option>
                    </select>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">è¾“å…¥è®¾ç½®</div>
                
                <div style="display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 14px; margin-bottom: 10px;">
                    <input type="checkbox" id="viewOnly" onchange="updateViewOnly()">
                    <label for="viewOnly" style="cursor: pointer;">ä»…æŸ¥çœ‹æ¨¡å¼</label>
                </div>
                
                <div style="display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 14px;">
                    <input type="checkbox" id="clipboardSync" checked onchange="updateClipboard()">
                    <label for="clipboardSync" style="cursor: pointer;">å‰ªè´´æ¿åŒæ­¥</label>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">è¿æ¥ä¿¡æ¯</div>
                <div style="color: #aaa; font-size: 12px; line-height: 1.8;">
                    <div>VM ID: <span id="infoVmId">-</span></div>
                    <div>åè®®: <span id="infoProtocol">VNC</span></div>
                    <div>å»¶è¿Ÿ: <span id="infoPing">-</span> ms</div>
                </div>
            </div>
        </div>
    </div>

    <div class="error-message" id="errorMessage" style="position: fixed; top: 70px; left: 50%; 
                                                       transform: translateX(-50%); z-index: 2000;"></div>

    <script src="/js/api.js"></script>
    <script type="module">
        import RFB from '/novnc/core/rfb.js';
        
        // å…¨å±€å˜é‡
        let rfb = null;
        let vmId = null;
        let token = null;
        let pingInterval = null;
        let pingStartTime = 0;
        
        // è·å–URLå‚æ•°
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                vmId: params.get('id'),
                token: params.get('token')
            };
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }
        
        // åˆå§‹åŒ–VNCè¿æ¥
        async function initVNC() {
            try {
                const params = getUrlParams();
                
                if (!params.vmId || !params.token) {
                    throw new Error('ç¼ºå°‘å¿…è¦å‚æ•°');
                }
                
                vmId = params.vmId;
                token = params.token;
                
                // æ›´æ–°VM IDæ˜¾ç¤º
                document.getElementById('infoVmId').textContent = vmId;
                
                // è·å–VNCè¿æ¥ä¿¡æ¯
                const result = await API.vnc.connect(vmId);
                
                if (!result.success) {
                    throw new Error(result.message || 'è·å–è¿æ¥ä¿¡æ¯å¤±è´¥');
                }
                
                const vncInfo = result.data;

                console.log('ğŸ“Š VNC Info from API:', {
                    host: vncInfo.host,
                    port: vncInfo.port,
                    hasPassword: !!vncInfo.password,
                    passwordLength: vncInfo.password ? vncInfo.password.length : 0,
                    passwordPreview: vncInfo.password ? vncInfo.password.substring(0, 3) + '***' : 'null'
                });

                // æ›´æ–°VMåç§°
                document.getElementById('vmName').textContent = vncInfo.vmName || `VM-${vmId}`;

                // æ„å»ºWebSocket URL
                const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                const wsUrl = `${protocol}://${window.location.host}/vnc/${vmId}?token=${token}`;

                console.log('Connecting to:', wsUrl);
                console.log('Using password:', vncInfo.password ? '***' + vncInfo.password.slice(-3) : 'NO PASSWORD');

                // åˆ›å»ºRFBè¿æ¥
                rfb = new RFB(
                    document.getElementById('vnc-screen'),
                    wsUrl,
                    {
                        credentials: {
                            password: vncInfo.password || '',
                        },
                        wsProtocols: ['binary'],
                    }
                );

                console.log('âœ… RFB instance created with credentials');
                
                // è®¾ç½®RFBäº‹ä»¶å¤„ç†
                rfb.addEventListener('connect', handleConnect);
                rfb.addEventListener('disconnect', handleDisconnect);
                rfb.addEventListener('credentialsrequired', handleCredentials);
                rfb.addEventListener('securityfailure', handleSecurityFailure);
                rfb.addEventListener('clipboard', handleClipboard);
                
                // è®¾ç½®é»˜è®¤é€‰é¡¹
                rfb.viewOnly = false;
                rfb.scaleViewport = true;
                rfb.resizeSession = false;
                rfb.qualityLevel = 6;
                rfb.compressionLevel = 2;
                
                // å¼€å§‹pingæµ‹è¯•
                startPingTest();
                
            } catch (error) {
                console.error('VNC initialization error:', error);
                Utils.showError('è¿æ¥åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                document.getElementById('loadingScreen').classList.remove('show');
                updateStatus('disconnected', 'è¿æ¥å¤±è´¥');
            }
        }
        
        // å¤„ç†è¿æ¥æˆåŠŸ
        function handleConnect(e) {
            console.log('VNC connected');
            document.getElementById('loadingScreen').classList.remove('show');
            updateStatus('connected', 'å·²è¿æ¥');
        }
        
        // å¤„ç†æ–­å¼€è¿æ¥
        function handleDisconnect(e) {
            console.log('VNC disconnected', e.detail);
            updateStatus('disconnected', 'å·²æ–­å¼€');
            stopPingTest();
            
            if (e.detail.clean) {
                Utils.showError('è¿æ¥å·²æ­£å¸¸æ–­å¼€');
            } else {
                Utils.showError('è¿æ¥æ„å¤–æ–­å¼€');
            }
        }
        
        // å¤„ç†å‡­æ®è¯·æ±‚
        function handleCredentials(e) {
            const password = prompt('è¯·è¾“å…¥VNCå¯†ç :');
            rfb.sendCredentials({ password: password || '' });
        }
        
        // å¤„ç†å®‰å…¨å¤±è´¥
        function handleSecurityFailure(e) {
            console.error('Security failure:', e.detail);
            Utils.showError('å®‰å…¨éªŒè¯å¤±è´¥: ' + (e.detail.reason || 'æœªçŸ¥é”™è¯¯'));
        }
        
        // å¤„ç†å‰ªè´´æ¿
        function handleClipboard(e) {
            if (document.getElementById('clipboardSync').checked) {
                navigator.clipboard.writeText(e.detail.text).catch(err => {
                    console.error('Clipboard write failed:', err);
                });
            }
        }
        
        // Pingæµ‹è¯•
        function startPingTest() {
            pingInterval = setInterval(() => {
                if (rfb && rfb._rfb_connection_state === 'connected') {
                    pingStartTime = Date.now();
                    // è¿™é‡Œå¯ä»¥å‘é€ä¸€ä¸ªå°çš„æµ‹è¯•æ¶ˆæ¯æ¥æµ‹é‡å»¶è¿Ÿ
                    // ç”±äºVNCåè®®é™åˆ¶ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿ
                    const ping = Math.floor(Math.random() * 20) + 10; // æ¨¡æ‹Ÿ10-30mså»¶è¿Ÿ
                    document.getElementById('infoPing').textContent = ping;
                }
            }, 5000);
        }
        
        function stopPingTest() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }
        
        // å…¨å±€å‡½æ•°
        window.sendCtrlAltDel = function() {
            if (rfb && rfb._rfb_connection_state === 'connected') {
                rfb.sendCtrlAltDel();
            } else {
                Utils.showError('æœªè¿æ¥åˆ°è¿œç¨‹æ¡Œé¢');
            }
        };
        
        window.disconnect = function() {
            if (confirm('ç¡®å®šè¦æ–­å¼€è¿æ¥å—ï¼Ÿ')) {
                if (rfb) {
                    rfb.disconnect();
                }
                stopPingTest();
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 1000);
            }
        };
        
        window.toggleFullscreen = function() {
            const elem = document.getElementById('vnc-container');
            
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    Utils.showError('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼');
                });
            } else {
                document.exitFullscreen();
            }
        };
        
        window.toggleControlPanel = function() {
            document.getElementById('controlPanel').classList.toggle('open');
        };
        
        window.updateScaling = function() {
            if (!rfb) return;
            
            const mode = document.getElementById('scalingMode').value;
            switch (mode) {
                case 'off':
                    rfb.scaleViewport = false;
                    rfb.resizeSession = false;
                    break;
                case 'scale':
                    rfb.scaleViewport = true;
                    rfb.resizeSession = false;
                    break;
                case 'remote':
                    rfb.scaleViewport = false;
                    rfb.resizeSession = true;
                    break;
            }
        };
        
        window.updateQuality = function() {
            if (!rfb) return;
            rfb.qualityLevel = parseInt(document.getElementById('quality').value);
        };
        
        window.updateCompression = function() {
            if (!rfb) return;
            rfb.compressionLevel = parseInt(document.getElementById('compression').value);
        };
        
        window.updateViewOnly = function() {
            if (!rfb) return;
            rfb.viewOnly = document.getElementById('viewOnly').checked;
        };
        
        window.updateClipboard = function() {
            // å‰ªè´´æ¿åŒæ­¥è®¾ç½®ä¼šåœ¨handleClipboardä¸­ä½¿ç”¨
        };
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initVNC();
        });
        
        // ç›‘å¬é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // F11 å…¨å±
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (rfb) {
                rfb.disconnect();
            }
            stopPingTest();
        });
    </script>
</body>
</html>