<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿæœºä»ªè¡¨æ¿ - noVNC Cloud Desktop</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/logger.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ–¥ï¸</div>
                <span>äº‘æ¡Œé¢ç®¡ç†ç³»ç»Ÿ</span>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: #666; font-size: 14px;">
                    ğŸ‘¤ <span id="currentUser">-</span>
                </span>
                <button class="btn" onclick="showSettingsModal()" style="background: #f5f5f5; color: #333;">âš™ï¸ è®¾ç½®</button>
                <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1 style="font-size: 28px; color: #333; margin-bottom: 10px;">æˆ‘çš„è™šæ‹Ÿæœº</h1>
        <p style="color: #666; margin-bottom: 30px;">ç®¡ç†å’Œè¿æ¥æ‚¨çš„äº‘æ¡Œé¢</p>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 20px;">
            <div style="flex: 1; max-width: 400px; position: relative;">
                <input type="text" class="form-input" id="searchInput" 
                       placeholder="æœç´¢è™šæ‹Ÿæœº..." style="padding-right: 40px;">
                <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999;">
                    ğŸ”
                </span>
            </div>
            <button class="btn btn-success" onclick="loadVMs()">
                <span>ğŸ”„</span>
                <span>åˆ·æ–°</span>
            </button>
        </div>

        <div class="vm-grid" id="vmGrid">
            <!-- è™šæ‹Ÿæœºå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div id="emptyState" style="display: none; text-align: center; padding: 60px 20px; color: #666;">
            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">ğŸ“¦</div>
            <div style="font-size: 20px; margin-bottom: 10px;">æš‚æ— è™šæ‹Ÿæœº</div>
            <div style="font-size: 14px; color: #999;">æ‚¨è¿˜æ²¡æœ‰å¯ç”¨çš„è™šæ‹Ÿæœº</div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingMessage">æ­£åœ¨åŠ è½½...</p>
        </div>
    </div>

    <!-- Connection Type Selector Modal -->
    <div class="modal-overlay" id="connectionModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 20px; color: #333;">é€‰æ‹©è¿æ¥æ–¹å¼</h2>
                <button onclick="closeConnectionModal()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <p style="color: #666; margin-bottom: 25px; font-size: 14px;">
                è¯·é€‰æ‹©æ‚¨å¸Œæœ›ä½¿ç”¨çš„è¿œç¨‹æ¡Œé¢åè®®
            </p>

            <div style="display: grid; gap: 15px;">
                <div class="connection-option" onclick="connectWithProtocol('spice')" style="cursor: pointer; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; display: flex; align-items: start; gap: 15px;">
                    <div style="font-size: 32px; line-height: 1;">âš¡</div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">SPICE (spice-html5)</div>
                        <div style="font-size: 13px; color: #666; line-height: 1.5;">
                            é«˜æ€§èƒ½è¿œç¨‹æ˜¾ç¤ºåè®®ï¼Œæä¾›æ›´å¥½çš„éŸ³é¢‘å’Œå›¾åƒè´¨é‡
                        </div>
                        <div style="margin-top: 8px;">
                            <span style="display: inline-block; padding: 3px 10px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 11px; font-weight: 500;">æ¨è</span>
                        </div>
                    </div>
                </div>

                <div class="connection-option" onclick="connectWithProtocol('vnc')" style="cursor: pointer; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; display: flex; align-items: start; gap: 15px;">
                    <div style="font-size: 32px; line-height: 1;">ğŸ–¥ï¸</div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">VNC (noVNC)</div>
                        <div style="font-size: 13px; color: #666; line-height: 1.5;">
                            é€šè¿‡ Web æµè§ˆå™¨è®¿é—®è™šæ‹Ÿæœºæ¡Œé¢ï¼Œæ”¯æŒå›¾åƒå‹ç¼©å’Œè´¨é‡è°ƒæ•´
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button class="btn" onclick="closeConnectionModal()" style="width: 100%;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 20px; color: #333;">è¿æ¥è®¾ç½®</h2>
                <button onclick="closeSettingsModal()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-size: 14px; color: #333; font-weight: 600; margin-bottom: 15px;">
                    é»˜è®¤è¿æ¥æ–¹å¼
                </label>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5;">
                    é€‰æ‹©ç‚¹å‡»"è¿æ¥æ¡Œé¢"æ—¶ä½¿ç”¨çš„é»˜è®¤åè®®ã€‚æ‚¨ä»ç„¶å¯ä»¥åœ¨è¿æ¥æ—¶æ‰‹åŠ¨é€‰æ‹©å…¶ä»–åè®®ã€‚
                </p>
                <div style="display: grid; gap: 12px;">
                    <label style="cursor: pointer; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                        <input type="radio" name="defaultProtocol" value="spice" onchange="saveDefaultProtocol('spice')" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 3px;">âš¡ SPICE (æ¨è)</div>
                            <div style="font-size: 12px; color: #666;">é«˜æ€§èƒ½è¿œç¨‹æ˜¾ç¤ºåè®®</div>
                        </div>
                    </label>
                    <label style="cursor: pointer; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                        <input type="radio" name="defaultProtocol" value="vnc" onchange="saveDefaultProtocol('vnc')" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 3px;">ğŸ–¥ï¸ VNC</div>
                            <div style="font-size: 12px; color: #666;">Webæµè§ˆå™¨è¿œç¨‹æ¡Œé¢</div>
                        </div>
                    </label>
                    <label style="cursor: pointer; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                        <input type="radio" name="defaultProtocol" value="ask" onchange="saveDefaultProtocol('ask')" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 3px;">â“ æ¯æ¬¡è¯¢é—®</div>
                            <div style="font-size: 12px; color: #666;">è¿æ¥æ—¶æ‰‹åŠ¨é€‰æ‹©åè®®</div>
                        </div>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="closeSettingsModal()" style="flex: 1;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .connection-option:hover {
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
    </style>

    <script src="/js/api.js"></script>
    <script>
        let vms = [];
        let selectedVmId = null;

        // æ˜¾ç¤ºè¿æ¥é€‰æ‹©å™¨æ¨¡æ€æ¡†
        function showConnectionModal(vmId) {
            console.log('ğŸ“ showConnectionModal called with vmId:', vmId);
            if (!vmId || vmId === 'undefined' || vmId === 'null') {
                console.error('âŒ Invalid vmId provided to showConnectionModal');
                Utils.showError('è™šæ‹ŸæœºIDæ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            selectedVmId = vmId;
            document.getElementById('connectionModal').style.display = 'flex';
        }

        // å…³é—­è¿æ¥é€‰æ‹©å™¨æ¨¡æ€æ¡†
        function closeConnectionModal() {
            // ä¸è¦ç«‹å³æ¸…ç©º selectedVmIdï¼Œç­‰åˆ°è¿æ¥å®Œæˆåå†æ¸…
            document.getElementById('connectionModal').style.display = 'none';
        }

        // æ˜¾ç¤ºè®¾ç½®æ¨¡æ€æ¡†
        function showSettingsModal() {
            // åŠ è½½å½“å‰è®¾ç½®
            const defaultProtocol = getDefaultProtocol();
            const radioButton = document.querySelector(`input[name="defaultProtocol"][value="${defaultProtocol}"]`);
            if (radioButton) {
                radioButton.checked = true;
            }
            document.getElementById('settingsModal').style.display = 'flex';
        }

        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // ä½¿ç”¨æŒ‡å®šåè®®è¿æ¥
        async function connectWithProtocol(protocol) {
            console.log('ğŸ”— connectWithProtocol called:', { protocol, selectedVmId });

            if (!selectedVmId || selectedVmId === 'undefined' || selectedVmId === 'null') {
                console.error('âŒ Invalid selectedVmId:', selectedVmId);
                Utils.showError('è™šæ‹ŸæœºIDæ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©');
                closeConnectionModal();
                selectedVmId = null;
                return;
            }

            // ä¿å­˜ vmId åˆ°æœ¬åœ°å˜é‡ï¼Œé˜²æ­¢è¢«æ¸…ç©º
            const vmId = selectedVmId;

            closeConnectionModal();
            Utils.showLoading('æ­£åœ¨å»ºç«‹è¿æ¥...');

            try {
                if (protocol === 'vnc') {
                    console.log('ğŸ–¥ï¸ Connecting via VNC for VM:', vmId);
                    const result = await API.vnc.connect(vmId);

                    if (result.success) {
                        // è·³è½¬åˆ°VNCé¡µé¢
                        window.location.href = `/vnc.html?id=${vmId}&token=${Utils.getToken()}`;
                    } else {
                        throw new Error(result.message || 'VNCè¿æ¥å¤±è´¥');
                    }
                } else if (protocol === 'spice') {
                    console.log('âš¡ Connecting via SPICE for VM:', vmId);

                    // è°ƒç”¨ SPICE è¿æ¥ API
                    const response = await fetch(`/api/spice/connect/${vmId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${Utils.getToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('ğŸ“¥ SPICE API response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('ğŸ“Š SPICE API result:', result);

                    if (result.success) {
                        // è·³è½¬åˆ°SPICEé¡µé¢
                        console.log('âœ… SPICE connection successful, redirecting...');

                        // Get GPU type from VM info for vGPU detection
                        const vm = vms.find(v => v.id === vmId);
                        const gpuType = vm && vm.gpuType ? vm.gpuType : '';

                        if (gpuType && gpuType.toLowerCase().includes('nvidia')) {
                            console.log('ğŸ® Detected vGPU VM with GPU type:', gpuType);
                        }

                        // Pass gpuType to SPICE client for resolution handling
                        const spiceUrl = `/spice.html?id=${vmId}&token=${Utils.getToken()}` +
                                        (gpuType ? `&gpuType=${encodeURIComponent(gpuType)}` : '');
                        window.location.href = spiceUrl;
                    } else {
                        throw new Error(result.message || 'SPICEè¿æ¥å¤±è´¥');
                    }
                }
            } catch (error) {
                console.error('âŒ Connect VM error:', error);
                Utils.showError('è¿æ¥è™šæ‹Ÿæœºå¤±è´¥: ' + error.message);
            } finally {
                selectedVmId = null;
                Utils.hideLoading();
            }
        }

        // åŠ è½½è™šæ‹Ÿæœºåˆ—è¡¨
        async function loadVMs() {
            Utils.showLoading('æ­£åœ¨åŠ è½½è™šæ‹Ÿæœºåˆ—è¡¨...');
            
            try {
                const result = await API.vm.list();
                vms = result.data || [];
                renderVMs();
            } catch (error) {
                console.error('Load VMs error:', error);
                Utils.showError('åŠ è½½è™šæ‹Ÿæœºåˆ—è¡¨å¤±è´¥: ' + error.message);
            } finally {
                Utils.hideLoading();
            }
        }
        
        // æ¸²æŸ“è™šæ‹Ÿæœºåˆ—è¡¨
        function renderVMs() {
            const grid = document.getElementById('vmGrid');
            const emptyState = document.getElementById('emptyState');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // è¿‡æ»¤è™šæ‹Ÿæœº
            const filteredVMs = vms.filter(vm => 
                vm.name?.toLowerCase().includes(searchTerm) ||
                vm.id?.toLowerCase().includes(searchTerm)
            );
            
            if (filteredVMs.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            grid.innerHTML = filteredVMs.map(vm => `
                <div class="card vm-card" data-vm-id="${vm.id}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px;">
                                ${vm.name || 'Unnamed VM'}
                            </div>
                            <div style="font-size: 12px; color: #999;">${vm.id}</div>
                        </div>
                        <span class="vm-status ${vm.status || 'unknown'}">
                            ${Utils.getStatusText(vm.status)}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
                                margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">CPU</div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${vm.cpu || '-'} æ ¸
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">å†…å­˜</div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${vm.memory || '-'} GB
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">ç³»ç»Ÿ</div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${vm.os || '-'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        ${renderVMActions(vm)}
                    </div>
                </div>
            `).join('');
        }
        
        // æ¸²æŸ“è™šæ‹Ÿæœºæ“ä½œæŒ‰é’®
        function renderVMActions(vm) {
            const isRunning = vm.status === 'running';
            const isStopped = vm.status === 'stopped' || vm.status === 'shutoff';
            const showForceReset = !isStopped; // éåœæ­¢çŠ¶æ€æ˜¾ç¤ºå¼ºåˆ¶é‡å¯æŒ‰é’®

            if (isRunning) {
                return `
                    <button class="btn btn-primary" style="flex: 1;" onclick="connectVM('${vm.id}')">
                        è¿æ¥æ¡Œé¢
                    </button>
                    <button class="btn btn-warning" style="flex: 0 0 auto; padding: 10px 15px;"
                            onclick="forceResetVM('${vm.id}')" title="å¼ºåˆ¶é‡å¯">
                        âš¡ å¼ºåˆ¶é‡å¯
                    </button>
                `;
            } else if (isStopped) {
                return `
                    <button class="btn btn-primary" style="flex: 1;" onclick="connectVM('${vm.id}')">
                        è¿æ¥æ¡Œé¢
                    </button>
                `;
            } else if (showForceReset) {
                // å…¶ä»–çŠ¶æ€ï¼ˆsuspended, paused, crashedç­‰ï¼‰æ˜¾ç¤ºå¼ºåˆ¶é‡å¯
                return `
                    <button class="btn" style="flex: 1;" disabled>
                        ä¸å¯ç”¨
                    </button>
                    <button class="btn btn-warning" style="flex: 0 0 auto; padding: 10px 15px;"
                            onclick="forceResetVM('${vm.id}')" title="å¼ºåˆ¶é‡å¯">
                        âš¡ å¼ºåˆ¶é‡å¯
                    </button>
                `;
            } else {
                return `
                    <button class="btn" style="flex: 1;" disabled>
                        ä¸å¯ç”¨
                    </button>
                `;
            }
        }
        
        // è·å–é»˜è®¤è¿æ¥åè®®
        function getDefaultProtocol() {
            const saved = localStorage.getItem('defaultProtocol');
            return saved || 'spice'; // é»˜è®¤ä½¿ç”¨ SPICE
        }

        // ä¿å­˜é»˜è®¤è¿æ¥åè®®
        function saveDefaultProtocol(protocol) {
            localStorage.setItem('defaultProtocol', protocol);
            console.log('ğŸ’¾ Default protocol saved:', protocol);
        }

        // è¿æ¥è™šæ‹Ÿæœº
        async function connectVM(vmId) {
            const defaultProtocol = getDefaultProtocol();
            console.log('ğŸ”Œ connectVM called:', { vmId, defaultProtocol });

            // æŸ¥æ‰¾è™šæ‹ŸæœºçŠ¶æ€
            const vm = vms.find(v => v.id === vmId);
            if (!vm) {
                Utils.showError('æœªæ‰¾åˆ°è™šæ‹Ÿæœº');
                return;
            }

            // å¦‚æœè™šæ‹Ÿæœºå·²å…³æœºï¼Œå…ˆå¯åŠ¨
            if (vm.status === 'stopped' || vm.status === 'shutoff') {
                console.log('âš¡ VM is offline, starting it first...');
                Utils.showLoading('è™šæ‹Ÿæœºå·²å…³æœºï¼Œæ­£åœ¨å¯åŠ¨...');

                try {
                    const result = await API.vm.start(vmId);

                    if (!result.success) {
                        throw new Error(result.message || 'å¯åŠ¨å¤±è´¥');
                    }

                    console.log('âœ… VM started successfully');
                    Utils.showLoading('è™šæ‹Ÿæœºå¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨å»ºç«‹è¿æ¥...');

                    // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©è™šæ‹Ÿæœºå®Œå…¨å¯åŠ¨
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // åˆ·æ–°è™šæ‹Ÿæœºåˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
                    await loadVMs();

                } catch (error) {
                    console.error('Start VM error:', error);
                    Utils.showError('å¯åŠ¨è™šæ‹Ÿæœºå¤±è´¥: ' + error.message);
                    Utils.hideLoading();
                    return;
                }
            }

            // è¿æ¥è™šæ‹Ÿæœº
            if (defaultProtocol === 'ask') {
                Utils.hideLoading();
                // æ˜¾ç¤ºè¿æ¥æ–¹å¼é€‰æ‹©å™¨
                showConnectionModal(vmId);
            } else {
                // ç›´æ¥ä½¿ç”¨é»˜è®¤åè®®è¿æ¥
                selectedVmId = vmId;
                connectWithProtocol(defaultProtocol);
            }
        }
        
        // å¯åŠ¨è™šæ‹Ÿæœº
        async function startVM(vmId) {
            if (!confirm('ç¡®å®šè¦å¯åŠ¨è¿™å°è™šæ‹Ÿæœºå—ï¼Ÿ')) {
                return;
            }
            
            Utils.showLoading('æ­£åœ¨å¯åŠ¨è™šæ‹Ÿæœº...');
            
            try {
                const result = await API.vm.start(vmId);
                
                if (result.success) {
                    alert('è™šæ‹Ÿæœºå¯åŠ¨æˆåŠŸ');
                    loadVMs();
                } else {
                    throw new Error(result.message || 'å¯åŠ¨å¤±è´¥');
                }
            } catch (error) {
                console.error('Start VM error:', error);
                Utils.showError('å¯åŠ¨è™šæ‹Ÿæœºå¤±è´¥: ' + error.message);
            } finally {
                Utils.hideLoading();
            }
        }
        
        // åœæ­¢è™šæ‹Ÿæœº
        async function stopVM(vmId) {
            if (!confirm('ç¡®å®šè¦åœæ­¢è¿™å°è™šæ‹Ÿæœºå—ï¼Ÿ')) {
                return;
            }

            Utils.showLoading('æ­£åœ¨åœæ­¢è™šæ‹Ÿæœº...');

            try {
                const result = await API.vm.stop(vmId);

                if (result.success) {
                    alert('è™šæ‹Ÿæœºåœæ­¢æˆåŠŸ');
                    loadVMs();
                } else {
                    throw new Error(result.message || 'åœæ­¢å¤±è´¥');
                }
            } catch (error) {
                console.error('Stop VM error:', error);
                Utils.showError('åœæ­¢è™šæ‹Ÿæœºå¤±è´¥: ' + error.message);
            } finally {
                Utils.hideLoading();
            }
        }

        // å¼ºåˆ¶é‡å¯è™šæ‹Ÿæœº
        async function forceResetVM(vmId) {
            if (!confirm('ç¡®å®šè¦å¼ºåˆ¶é‡å¯æ­¤è™šæ‹Ÿæœºå—ï¼Ÿ\n\nå¼ºåˆ¶é‡å¯ç›¸å½“äºæŒ‰ä¸‹ç”µè„‘çš„é‡ç½®æŒ‰é’®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªä¿å­˜çš„æ•°æ®ä¸¢å¤±ã€‚')) {
                return;
            }

            Utils.showLoading('æ­£åœ¨å¼ºåˆ¶é‡å¯è™šæ‹Ÿæœº...');

            try {
                const result = await API.vm.forceReset(vmId);

                if (result.success) {
                    Utils.showSuccess('è™šæ‹Ÿæœºå¼ºåˆ¶é‡å¯å‘½ä»¤å·²å‘é€');
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´ååˆ·æ–°åˆ—è¡¨
                    setTimeout(() => {
                        loadVMs();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'å¼ºåˆ¶é‡å¯å¤±è´¥');
                }
            } catch (error) {
                console.error('Force reset VM error:', error);
                Utils.showError('å¼ºåˆ¶é‡å¯è™šæ‹Ÿæœºå¤±è´¥: ' + error.message);
            } finally {
                Utils.hideLoading();
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                try {
                    await API.auth.logout();
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                Utils.clearToken();
                window.location.href = '/';
            }
        }
        
        // æœç´¢è™šæ‹Ÿæœº
        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderVMs();
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·å
            document.getElementById('currentUser').textContent = Utils.getUsername() || 'ç”¨æˆ·';
            
            // åŠ è½½è™šæ‹Ÿæœºåˆ—è¡¨
            loadVMs();
            
            // å®šæœŸåˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
            setInterval(loadVMs, 30000);
        });
    </script>
</body>
</html>